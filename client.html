<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Scanner - Socket.io</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <!-- Clerk JavaScript SDK -->
    <script async crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@5/dist/clerk.browser.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.processing {
            background: #cfe2ff;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            font-size: 13px;
            font-style: italic;
            max-width: 100%;
            text-align: center;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            max-width: 100%;
        }

        .message.structured {
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
        }

        .structured-analysis {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .structured-analysis h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .analysis-field {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .analysis-field strong {
            color: #667eea;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .analysis-field ul {
            margin: 10px 0 0 20px;
            padding: 0;
            list-style-type: disc;
        }

        .analysis-field li {
            margin: 5px 0;
            color: #333;
        }

        .message.seo-recommendation {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            max-width: 95%;
        }

        .seo-analysis h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ranking-badge {
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin: 0 3px;
        }

        .ranking-badge.google {
            background: #4285f4;
        }

        .ranking-badge.bing {
            background: #008373;
        }

        .ranking-badge.not-ranked {
            background: #ffc107;
            color: #333;
        }

        .seo-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .seo-section:last-child {
            margin-bottom: 0;
        }

        .seo-section strong {
            color: #667eea;
            display: block;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .seo-content {
            color: #333;
            line-height: 1.6;
        }

        .seo-content p {
            margin: 10px 0;
        }

        .seo-content ul,
        .seo-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .seo-content li {
            margin: 5px 0;
        }

        /* Progress Bar Styles */
        .progress-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            display: none;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .mode-toggle {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            gap: 20px;
        }

        .mode-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }

        .mode-toggle input[type="radio"] {
            cursor: pointer;
        }

        .mode-toggle label:has(input:checked) {
            color: #667eea;
            font-weight: 600;
        }

        /* Screenshot Display Styles */
        .message.screenshot {
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            max-width: 95%;
        }

        .screenshot-container {
            position: relative;
            margin-bottom: 10px;
        }

        .screenshot-container img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
        }

        .screenshot-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            height: 300px;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .screenshot-label {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .full-quality-link {
            font-size: 12px;
            color: #667eea;
            text-decoration: none;
            margin-top: 8px;
            display: inline-block;
        }

        .full-quality-link:hover {
            text-decoration: underline;
        }

        /* Authentication UI Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            flex: 1;
        }

        .auth-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .auth-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .auth-badge.anonymous {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .auth-badge.authenticated {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .user-info {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-auth {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-auth:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-auth.secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #d0d0d0;
        }

        .btn-auth.secondary:hover {
            background: #e0e0e0;
        }

        /* Error Banner Styles */
        .error-banner {
            display: none;
            padding: 15px 20px;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
        }

        .error-banner.visible {
            display: block;
        }

        .error-banner-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .error-banner-text {
            flex: 1;
        }

        .error-banner-actions {
            display: flex;
            gap: 10px;
        }

        .btn-close {
            background: transparent;
            border: none;
            color: #721c24;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }

        .btn-retry {
            padding: 6px 12px;
            background: #721c24;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-retry:hover {
            background: #5a161c;
        }

        /* Clerk Configuration Styles */
        .clerk-config {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }

        .clerk-config-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
        }

        .clerk-config-input-group {
            display: flex;
            gap: 8px;
        }

        .clerk-config-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            font-size: 13px;
            font-family: monospace;
        }

        .clerk-config-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .clerk-config-input::placeholder {
            color: #999;
        }

        .btn-save-clerk {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-save-clerk:hover {
            background: #5568d3;
        }

        .btn-save-clerk:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clerk-config-hint {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .clerk-config-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .clerk-config-status.success {
            background: #d4edda;
            color: #155724;
        }

        .clerk-config-status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header with Auth Controls -->
        <div class="header">
            <div class="header-left">
                <h1>Website Scanner (Socket.io)</h1>
                <p class="subtitle">AI-powered website analysis with real-time updates</p>
            </div>
            <div class="auth-controls">
                <div id="authStatus" class="auth-badge anonymous">Anonymous</div>
                <div id="userInfo" class="user-info" style="display: none;"></div>
                <button id="signInBtn" class="btn-auth" onclick="handleSignIn()" style="display: none;">Sign In</button>
                <button id="signOutBtn" class="btn-auth secondary" onclick="handleSignOut()" style="display: none;">Sign Out</button>
            </div>
        </div>

        <!-- Error Banner -->
        <div id="errorBanner" class="error-banner">
            <div class="error-banner-content">
                <div class="error-banner-text" id="errorBannerText"></div>
                <div class="error-banner-actions">
                    <button id="retryBtn" class="btn-retry" onclick="retryLastAction()" style="display: none;">Retry</button>
                    <button class="btn-close" onclick="dismissErrorBanner()">×</button>
                </div>
            </div>
        </div>

        <!-- Clerk Configuration -->
        <div id="clerkConfig" class="clerk-config" style="display: none;">
            <label class="clerk-config-label">
                🔐 Clerk Publishable Key (Optional - for Authentication)
                <span id="clerkConfigStatus" class="clerk-config-status" style="display: none;"></span>
            </label>
            <div class="clerk-config-input-group">
                <input
                    type="text"
                    id="clerkKeyInput"
                    class="clerk-config-input"
                    placeholder="pk_test_... or pk_live_..."
                    onkeypress="handleClerkKeyEnter(event)"
                />
                <button id="saveClerkBtn" class="btn-save-clerk" onclick="saveClerkKey()">Save & Enable Auth</button>
            </div>
            <div class="clerk-config-hint">
                Leave empty to use anonymous mode only. Get your key from <a href="https://dashboard.clerk.com" target="_blank">Clerk Dashboard</a>
            </div>
        </div>

        <div id="status" class="status connecting">
            Connecting to server...
        </div>

        <div class="mode-toggle">
            <label>
                <input type="radio" name="scanMethod" value="api" checked>
                REST API + Socket.io (Recommended)
            </label>
            <label>
                <input type="radio" name="scanMethod" value="socket">
                Socket.io Only
            </label>
        </div>

        <div class="quick-actions">
            <button class="quick-btn" onclick="sendQuickURL('https://github.com')">GitHub</button>
            <button class="quick-btn" onclick="sendQuickURL('https://news.ycombinator.com')">Hacker News</button>
            <button class="quick-btn" onclick="sendQuickURL('https://www.anthropic.com')">Anthropic</button>
            <button class="quick-btn" onclick="clearChat()">Clear Chat</button>
        </div>

        <div id="progressContainer" class="progress-container">
            <div class="progress-bar-wrapper">
                <div id="progressBar" class="progress-bar" role="progressbar"
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    0%
                </div>
            </div>
            <div id="progressText" class="progress-text">Initializing...</div>
        </div>

        <div id="chatContainer" class="chat-container"></div>

        <div class="input-container">
            <input
                type="text"
                id="urlInput"
                placeholder="Enter a website URL (e.g., https://example.com)..."
                onkeypress="handleKeyPress(event)"
            />
            <button id="sendBtn" onclick="sendMessage()" disabled>Analyze</button>
        </div>
    </div>

    <script>
        // ============================================================
        // CONFIGURATION
        // ============================================================
        //
        // AUTO-DETECTION: URLs are automatically set based on the page origin
        // - If client.html is served from https://example.com, API calls go to https://example.com/api
        // - If client.html is served from http://localhost:8010, API calls go to http://localhost:8010/api
        //
        // OVERRIDE: For cross-origin setups, set window.APP_* globals before loading this script:
        //   <script>
        //     window.APP_API_BASE_URL = 'https://api.example.com/api';
        //     window.APP_SOCKET_URL = 'https://api.example.com';
        //     window.APP_CLERK_PUBLISHABLE_KEY = 'pk_test_...';
        //   </script>
        //
        const CONFIG = {
            // API base URL - auto-detects from page origin (e.g., https://example.com/api)
            API_BASE_URL: window.APP_API_BASE_URL || (window.location.origin + '/api'),

            // Socket.IO server URL - auto-detects from page origin (e.g., https://example.com)
            SOCKET_URL: window.APP_SOCKET_URL || window.location.origin,

            // Socket.IO path - standard path, rarely needs changing
            SOCKET_PATH: window.APP_SOCKET_PATH || '/socket.io',

            // Clerk publishable key - REQUIRED for authentication
            // Priority: 1) window.APP_CLERK_PUBLISHABLE_KEY 2) localStorage 3) empty
            // Can be set via UI input field
            CLERK_PUBLISHABLE_KEY: window.APP_CLERK_PUBLISHABLE_KEY ||
                                   localStorage.getItem('clerk_publishable_key') || '',

            // Cookie-based auth (set true if backend uses HTTP-only cookies)
            USE_COOKIES: false
        };

        console.log('🔗 API Base URL:', CONFIG.API_BASE_URL);
        console.log('🔌 Socket URL:', CONFIG.SOCKET_URL);
        console.log('🔐 Clerk enabled:', !!CONFIG.CLERK_PUBLISHABLE_KEY);

        // ============================================================
        // STATE MANAGEMENT
        // ============================================================
        const state = {
            socket: null,
            sessionId: null,
            currentScanId: null,
            isAuthenticated: false,
            isConnected: false,
            clerk: null,
            user: null,
            lastFailedAction: null // For retry functionality
        };

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================

        /**
         * Get or create session ID for anonymous users
         */
        function getOrCreateSessionId() {
            const SESSION_KEY = 'session_id';
            let sessionId = localStorage.getItem(SESSION_KEY);

            if (!sessionId) {
                sessionId = crypto.randomUUID();
                localStorage.setItem(SESSION_KEY, sessionId);
                console.log('Generated new session ID:', sessionId);
            }

            return sessionId;
        }

        /**
         * Get Clerk authentication token
         */
        async function getClerkToken() {
            if (!state.clerk || !state.isAuthenticated) {
                return null;
            }

            try {
                // Get token with supabase template as backend expects
                const token = await state.clerk.session.getToken({ template: 'supabase' });
                return token;
            } catch (error) {
                console.error('Error getting Clerk token:', error);
                return null;
            }
        }

        /**
         * Build headers for API requests with authentication
         */
        async function buildHeaders(includeContentType = true) {
            const headers = {};

            if (includeContentType) {
                headers['Content-Type'] = 'application/json';
            }

            // Authenticated user - add Bearer token
            if (state.isAuthenticated && state.clerk) {
                const token = await getClerkToken();
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
            }

            // Add session ID (for anonymous or for claiming scans)
            if (state.sessionId) {
                headers['X-Session-ID'] = state.sessionId;
            }

            return headers;
        }

        /**
         * Validate URL format
         */
        function isValidUrl(str) {
            try {
                const url = new URL(str);
                return ['http:', 'https:'].includes(url.protocol);
            } catch {
                return false;
            }
        }

        // ============================================================
        // SOCKET.IO INITIALIZATION
        // ============================================================

        /**
         * Initialize Socket.io connection with auth support
         */
        function initializeSocket() {
            console.log('Initializing Socket.io connection...');

            state.socket = io(CONFIG.SOCKET_URL, {
                path: CONFIG.SOCKET_PATH,
                reconnection: true,
                reconnectionDelay: 3000,
                reconnectionAttempts: Infinity,
                withCredentials: CONFIG.USE_COOKIES
            });

            // Connection events
            state.socket.on('connect', handleConnect);
            state.socket.on('disconnect', handleDisconnect);
            state.socket.on('connect_error', handleConnectError);

            // Auth events
            state.socket.on('auth_response', handleAuthResponse);

            // Scan events
            state.socket.on('analyze_response', handleAnalyzeResponse);
            state.socket.on('scan:progress', handleScanProgress);
            state.socket.on('scan:screenshot_loading', handleScanScreenshotLoading);
            state.socket.on('scan:screenshot', handleScanScreenshot);
            state.socket.on('scan:completed', handleScanCompleted);
            state.socket.on('scan:failed', handleScanFailed);
            state.socket.on('scan:issue', handleScanIssue);

            // Room events
            state.socket.on('joined', handleRoomJoined);
            state.socket.on('left', handleRoomLeft);

            // Error events
            state.socket.on('error', handleError);
        }

        // ============================================================
        // CONNECTION HANDLERS
        // ============================================================

        async function handleConnect() {
            console.log('Socket.io connected');
            state.isConnected = true;

            // Send authentication data to server
            const token = await getClerkToken();
            const sessionId = state.sessionId || getOrCreateSessionId();

            console.log('Emitting auth event - token:', !!token, 'sessionId:', sessionId);
            state.socket.emit('auth', {
                token: token,
                session_id: sessionId
            });

            // Status will be updated after receiving auth_response
            updateStatus('connected', '⟳ Authenticating...');
        }

        function handleDisconnect() {
            console.log('Socket.io disconnected');
            state.isConnected = false;
            updateStatus('disconnected', '✗ Disconnected from server');
            document.getElementById('sendBtn').disabled = true;
        }

        function handleConnectError(error) {
            console.error('Socket.io connection error:', error);
            updateStatus('disconnected', '✗ Connection error');
            showErrorBanner(`Connection error: ${error.message || 'Unknown error'}`);
        }

        // ============================================================
        // AUTH HANDLERS
        // ============================================================

        function handleAuthResponse(data) {
            console.log('Auth response:', data);

            // Update session ID if provided (anonymous users)
            if (data.session_id) {
                state.sessionId = data.session_id;
                localStorage.setItem('session_id', data.session_id);
            }

            // Update authenticated state
            state.isAuthenticated = data.authenticated || false;

            // Update UI
            updateAuthUI();

            // Enable send button
            document.getElementById('sendBtn').disabled = false;

            // Update connection status
            const statusText = state.isAuthenticated
                ? '✓ Connected (authenticated)'
                : '✓ Connected (anonymous)';
            updateStatus('connected', statusText);
        }

        // Scan event handlers
        function handleAnalyzeResponse(data) {
            console.log('Analyze response:', data);
            state.currentScanId = data.scan_id;
            addMessage('system', `✓ Scan created: ${data.scan_id}`);
            showProgressBar();
        }

        function handleScanProgress(data) {
            console.log('Scan progress:', data);
            updateProgressBar(data.percent, data.message);
        }

        function handleScanScreenshotLoading(data) {
            console.log('Screenshot loading for scan:', data.scan_id);
            displayScreenshotLoading(data.scan_id);
        }

        function handleScanScreenshot(data) {
            console.log('Screenshot received for scan:', data.scan_id);
            displayScreenshot(data.screenshot, data.scan_id);
        }

        function handleScanCompleted(data) {
            console.log('Scan completed:', data);
            hideProgressBar();

            // Display results
            if (data.results) {
                if (data.results.analysis) {
                    displayStructuredAnalysis(data.results.analysis);
                }

                if (data.results.seo) {
                    displaySEORecommendation(data.results.seo);
                }
            }

            addMessage('system', '✅ Scan completed successfully!');
            updateStatus('connected', '✓ Connected to server');
        }

        function handleScanFailed(data) {
            console.error('Scan failed:', data);
            hideProgressBar();
            addMessage('error', `✗ Scan failed: ${data.error}`);
            updateStatus('connected', '✓ Connected to server');
        }

        function handleScanIssue(data) {
            console.log('Scan issue:', data);
            addMessage('system', `⚠ Issue: ${JSON.stringify(data.issue)}`);
        }

        // Room handlers
        function handleRoomJoined(data) {
            console.log('Joined room:', data);
        }

        function handleRoomLeft(data) {
            console.log('Left room:', data);
        }

        // Error handler
        function handleError(data) {
            console.error('Socket.io error:', data);
            addMessage('error', data.message || 'An error occurred');
        }

        // ============================================================
        // REST API FUNCTIONS
        // ============================================================

        /**
         * Create scan via REST API (recommended method)
         */
        async function createScanViaAPI(url) {
            try {
                updateStatus('processing', '⏳ Creating scan...');

                // Build headers with authentication
                const headers = await buildHeaders();

                const response = await fetch(`${CONFIG.API_BASE_URL}/scans`, {
                    method: 'POST',
                    headers: headers,
                    credentials: CONFIG.USE_COOKIES ? 'include' : 'same-origin',
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.detail || `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                console.log('Scan created via API:', data);

                // Save current scan ID
                state.currentScanId = data.scan_id;

                addMessage('system', `✓ Scan created: ${data.scan_id}`);

                // Join scan room via Socket.io
                state.socket.emit('join', {
                    scan_id: data.scan_id
                });

                // Show progress bar
                showProgressBar();
                updateStatus('processing', '⏳ Scanning...');

                return data;
            } catch (error) {
                console.error('Error creating scan:', error);
                showErrorBanner(`Failed to create scan: ${error.message}`, () => createScanViaAPI(url));
                updateStatus('connected', '✓ Connected to server');
                throw error;
            }
        }

        // Socket.io scan creation
        function createScanViaSocket(url, mode = 'structured') {
            if (!state.socket || !state.socket.connected) {
                addMessage('error', 'Not connected to server');
                return;
            }

            updateStatus('processing', '⏳ Starting scan...');

            state.socket.emit('analyze', {
                url: url,
                mode: mode
            });

            showProgressBar();
        }

        // UI Functions
        function updateStatus(state, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${state}`;
            statusEl.textContent = message;
        }

        function showProgressBar() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.classList.add('visible');
            updateProgressBar(0, 'Starting scan...');
        }

        function updateProgressBar(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            progressBar.style.width = `${percent}%`;
            progressBar.setAttribute('aria-valuenow', percent);
            progressBar.textContent = `${percent}%`;
            progressText.textContent = `${percent}% - ${message}`;
        }

        function hideProgressBar() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.classList.remove('visible');
        }

        function addMessage(type, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = content;
            chatContainer.appendChild(messageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageEl;
        }

        function displayScreenshotLoading(scanId) {
            const chatContainer = document.getElementById('chatContainer');

            // Create loading placeholder
            const screenshotEl = document.createElement('div');
            screenshotEl.className = 'message screenshot';
            screenshotEl.id = `screenshot-${scanId}`;

            screenshotEl.innerHTML = `
                <div class="screenshot-label">
                    📸 Page Screenshot (Preview)
                </div>
                <div class="screenshot-container">
                    <div class="screenshot-loading"></div>
                </div>
            `;

            chatContainer.appendChild(screenshotEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayScreenshot(screenshotDataUrl, scanId) {
            // Validate data URI format
            if (!screenshotDataUrl || !screenshotDataUrl.startsWith('data:image/')) {
                console.error('Invalid screenshot data URL format');
                return;
            }

            // Validate scanId format (UUID)
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!scanId || !uuidRegex.test(scanId)) {
                console.error('Invalid scan ID format');
                return;
            }

            const chatContainer = document.getElementById('chatContainer');

            // Check if loading placeholder exists
            const existingScreenshot = document.getElementById(`screenshot-${scanId}`);

            if (existingScreenshot) {
                // Update existing placeholder with actual screenshot
                existingScreenshot.innerHTML = `
                    <div class="screenshot-label">
                        📸 Page Screenshot (Preview)
                    </div>
                    <div class="screenshot-container">
                        <img src="${screenshotDataUrl}" alt="Website Screenshot" loading="lazy">
                    </div>
                    <a href="javascript:void(0)" onclick="fetchAndOpenScreenshot('${scanId}')" class="full-quality-link">
                        🔍 View Full Quality Screenshot
                    </a>
                `;
            } else {
                // Create new screenshot element if loading wasn't shown
                const screenshotEl = document.createElement('div');
                screenshotEl.className = 'message screenshot';
                screenshotEl.id = `screenshot-${scanId}`;

                screenshotEl.innerHTML = `
                    <div class="screenshot-label">
                        📸 Page Screenshot (Preview)
                    </div>
                    <div class="screenshot-container">
                        <img src="${screenshotDataUrl}" alt="Website Screenshot" loading="lazy">
                    </div>
                    <a href="javascript:void(0)" onclick="fetchAndOpenScreenshot('${scanId}')" class="full-quality-link">
                        🔍 View Full Quality Screenshot
                    </a>
                `;

                chatContainer.appendChild(screenshotEl);
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayStructuredAnalysis(analysis) {
            const chatContainer = document.getElementById('chatContainer');

            const analysisEl = document.createElement('div');
            analysisEl.className = 'message assistant structured';

            // Sanitize all user-controlled fields to prevent XSS
            const sanitizedType = DOMPurify.sanitize(analysis.website_type || 'N/A');
            const sanitizedGoal = DOMPurify.sanitize(analysis.primary_goal || 'N/A');
            const sanitizedDescription = DOMPurify.sanitize(analysis.description || 'N/A');
            const sanitizedFeatures = (analysis.key_features || [])
                .map(f => `<li>${DOMPurify.sanitize(f)}</li>`)
                .join('');
            const sanitizedKeywords = DOMPurify.sanitize((analysis.keywords || []).join(', ') || 'N/A');

            analysisEl.innerHTML = `
                <div class="structured-analysis">
                    <h3>📊 Website Analysis</h3>
                    <div class="analysis-field">
                        <strong>Type:</strong> ${sanitizedType}
                    </div>
                    <div class="analysis-field">
                        <strong>Primary Goal:</strong> ${sanitizedGoal}
                    </div>
                    <div class="analysis-field">
                        <strong>Description:</strong> ${sanitizedDescription}
                    </div>
                    <div class="analysis-field">
                        <strong>Key Features:</strong>
                        <ul>
                            ${sanitizedFeatures}
                        </ul>
                    </div>
                    <div class="analysis-field">
                        <strong>Keywords:</strong> ${sanitizedKeywords}
                    </div>
                </div>
            `;

            chatContainer.appendChild(analysisEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displaySEORecommendation(seo) {
            const chatContainer = document.getElementById('chatContainer');

            const seoEl = document.createElement('div');
            seoEl.className = 'message seo-recommendation';

            // Ranking badges
            const googleBadge = seo.google_ranking
                ? `<span class="ranking-badge google">Google #${seo.google_ranking}</span>`
                : `<span class="ranking-badge not-ranked">Not in Top 10</span>`;

            const bingBadge = seo.bing_ranking
                ? `<span class="ranking-badge bing">Bing #${seo.bing_ranking}</span>`
                : `<span class="ranking-badge not-ranked">Not in Top 10</span>`;

            // Sanitize markdown output to prevent XSS attacks
            const sanitizedFindings = DOMPurify.sanitize(marked.parse(seo.findings || 'No findings available'));
            const sanitizedRecommendations = DOMPurify.sanitize(marked.parse(seo.recommendations || 'No recommendations available'));
            const sanitizedAttention = DOMPurify.sanitize(marked.parse(seo.require_attention || 'No critical issues'));

            seoEl.innerHTML = `
                <div class="seo-analysis">
                    <h3>🎯 SEO Analysis ${googleBadge} ${bingBadge}</h3>
                    <div class="seo-section">
                        <strong>Findings</strong>
                        <div class="seo-content">${sanitizedFindings}</div>
                    </div>
                    <div class="seo-section">
                        <strong>Recommendations</strong>
                        <div class="seo-content">${sanitizedRecommendations}</div>
                    </div>
                    <div class="seo-section">
                        <strong>Require Attention</strong>
                        <div class="seo-content">${sanitizedAttention}</div>
                    </div>
                </div>
            `;

            chatContainer.appendChild(seoEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chatContainer').innerHTML = '';
        }

        /**
         * Fetch and open full quality screenshot
         */
        async function fetchAndOpenScreenshot(scanId) {
            try {
                // Build headers with authentication
                const headers = await buildHeaders(false); // Don't include Content-Type for GET

                const response = await fetch(`${CONFIG.API_BASE_URL}/scans/${scanId}/screenshot-url`, {
                    method: 'GET',
                    headers: headers,
                    credentials: CONFIG.USE_COOKIES ? 'include' : 'same-origin'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMsg = errorData.detail || `HTTP ${response.status} ${response.statusText}`;
                    throw new Error(errorMsg);
                }

                const data = await response.json();

                // Validate screenshot URL
                if (!data.screenshot_url) {
                    throw new Error('No screenshot_url in response');
                }

                // Validate the URL format
                try {
                    new URL(data.screenshot_url);
                } catch {
                    throw new Error('Invalid screenshot URL format');
                }

                // Open in new tab
                window.open(data.screenshot_url, '_blank', 'noopener');

                console.log('Screenshot opened successfully');

            } catch (error) {
                console.error('Error fetching screenshot:', error);
                const errorMsg = `Failed to load full quality screenshot: ${error.message}`;
                showErrorBanner(errorMsg, () => fetchAndOpenScreenshot(scanId));
                addMessage('error', errorMsg);
            }
        }

        // ============================================================
        // USER ACTION HANDLERS
        // ============================================================

        /**
         * Send URL for scanning
         */
        async function sendMessage() {
            const input = document.getElementById('urlInput');
            const url = input.value.trim();

            if (!url) return;

            // Validate URL format
            if (!isValidUrl(url)) {
                showErrorBanner('Please enter a valid http(s) URL');
                return;
            }

            if (!state.socket || !state.socket.connected) {
                showErrorBanner('Not connected to server. Please wait for connection.');
                return;
            }

            // Display user input
            addMessage('user', url);

            // Get selected scan method
            const scanMethod = document.querySelector('input[name="scanMethod"]:checked').value;

            try {
                if (scanMethod === 'api') {
                    // Create scan via REST API (recommended)
                    await createScanViaAPI(url);
                } else {
                    // Create scan via Socket.io
                    createScanViaSocket(url, 'structured');
                }
            } catch (error) {
                // Error already handled in respective functions
            }

            // Clear input
            input.value = '';
        }

        async function sendQuickURL(url) {
            if (!state.socket || !state.socket.connected) {
                addMessage('error', '✗ Not connected to server');
                return;
            }

            addMessage('user', url);

            const scanMethod = document.querySelector('input[name="scanMethod"]:checked').value;

            try {
                if (scanMethod === 'api') {
                    await createScanViaAPI(url);
                } else {
                    createScanViaSocket(url, 'structured');
                }
            } catch (error) {
                // Error already handled
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ============================================================
        // CLERK AUTHENTICATION FUNCTIONS
        // ============================================================

        /**
         * Validate Clerk publishable key format
         */
        function isValidClerkKey(key) {
            if (!key || typeof key !== 'string') return false;
            return key.startsWith('pk_test_') || key.startsWith('pk_live_');
        }

        /**
         * Save Clerk key from UI input
         */
        async function saveClerkKey() {
            const input = document.getElementById('clerkKeyInput');
            const saveBtn = document.getElementById('saveClerkBtn');
            const statusEl = document.getElementById('clerkConfigStatus');
            const key = input.value.trim();

            // Validate key format
            if (key && !isValidClerkKey(key)) {
                statusEl.textContent = '✗ Invalid key format';
                statusEl.className = 'clerk-config-status error';
                statusEl.style.display = 'inline-block';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
                return;
            }

            // Save to localStorage
            if (key) {
                localStorage.setItem('clerk_publishable_key', key);
                CONFIG.CLERK_PUBLISHABLE_KEY = key;
                console.log('✅ Clerk key saved to localStorage');
            } else {
                localStorage.removeItem('clerk_publishable_key');
                CONFIG.CLERK_PUBLISHABLE_KEY = '';
                console.log('🗑️ Clerk key removed from localStorage');
            }

            // Show success status
            statusEl.textContent = key ? '✓ Saved' : '✓ Removed';
            statusEl.className = 'clerk-config-status success';
            statusEl.style.display = 'inline-block';

            // Disable button temporarily
            saveBtn.disabled = true;
            saveBtn.textContent = 'Initializing...';

            // Initialize or re-initialize Clerk
            await initializeClerk();

            // Update UI
            updateAuthUI();
            updateClerkConfigUI();

            // Re-enable button
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save & Enable Auth';

            // Hide status after 3 seconds
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        /**
         * Handle Enter key in Clerk input
         */
        function handleClerkKeyEnter(event) {
            if (event.key === 'Enter') {
                saveClerkKey();
            }
        }

        /**
         * Update Clerk configuration UI visibility
         */
        function updateClerkConfigUI() {
            const configSection = document.getElementById('clerkConfig');
            const keyInput = document.getElementById('clerkKeyInput');

            // Show config section if no key is set via window variable
            const hasWindowKey = !!window.APP_CLERK_PUBLISHABLE_KEY;
            const shouldShowConfig = !hasWindowKey;

            configSection.style.display = shouldShowConfig ? 'block' : 'none';

            // Populate input with current stored key
            if (shouldShowConfig) {
                const storedKey = localStorage.getItem('clerk_publishable_key') || '';
                keyInput.value = storedKey;
            }
        }

        /**
         * Initialize Clerk authentication
         */
        async function initializeClerk() {
            if (!CONFIG.CLERK_PUBLISHABLE_KEY) {
                console.warn('Clerk publishable key not configured. Authentication disabled.');
                updateAuthUI(); // Update UI to show anonymous state
                updateClerkConfigUI(); // Show config input
                return;
            }

            try {
                console.log('Initializing Clerk...');

                // Wait for Clerk to be available
                if (typeof Clerk === 'undefined') {
                    console.warn('Clerk SDK not loaded. Authentication disabled.');
                    return;
                }

                // Initialize Clerk using CDN global pattern
                state.clerk = window.Clerk;
                await state.clerk.load({
                    publishableKey: CONFIG.CLERK_PUBLISHABLE_KEY
                });

                console.log('Clerk initialized successfully');

                // Check if user is already signed in
                if (state.clerk.user) {
                    state.user = state.clerk.user;
                    state.isAuthenticated = true;
                    console.log('User already signed in:', state.user.id);

                    // Claim anonymous scans
                    await claimAnonymousScans();
                }

                // Update UI
                updateAuthUI();

                // Listen for auth changes
                state.clerk.addListener((event) => {
                    console.log('Clerk auth event:', event);
                    if (event.user) {
                        state.user = event.user;
                        state.isAuthenticated = true;
                    } else {
                        state.user = null;
                        state.isAuthenticated = false;
                    }
                    updateAuthUI();
                });

            } catch (error) {
                console.error('Error initializing Clerk:', error);
                showErrorBanner('Failed to initialize authentication. Continuing in anonymous mode.');
            }
        }

        /**
         * Update authentication UI based on current state
         */
        function updateAuthUI() {
            const authStatus = document.getElementById('authStatus');
            const userInfo = document.getElementById('userInfo');
            const signInBtn = document.getElementById('signInBtn');
            const signOutBtn = document.getElementById('signOutBtn');

            if (state.isAuthenticated && state.user) {
                // Authenticated state
                authStatus.className = 'auth-badge authenticated';
                authStatus.textContent = 'Authenticated';

                userInfo.style.display = 'flex';
                userInfo.textContent = state.user.primaryEmailAddress?.emailAddress || state.user.id;

                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'block';
            } else {
                // Anonymous state
                authStatus.className = 'auth-badge anonymous';
                authStatus.textContent = 'Anonymous';

                userInfo.style.display = 'none';

                signInBtn.style.display = CONFIG.CLERK_PUBLISHABLE_KEY ? 'block' : 'none';
                signOutBtn.style.display = 'none';
            }
        }

        /**
         * Handle sign in
         */
        async function handleSignIn() {
            if (!state.clerk) {
                showErrorBanner('Authentication not available. Please reload the page.');
                return;
            }

            try {
                await state.clerk.openSignIn();
            } catch (error) {
                console.error('Error opening sign in:', error);
                showErrorBanner('Failed to open sign in dialog. Please try again.');
            }
        }

        /**
         * Handle sign out
         */
        async function handleSignOut() {
            if (!state.clerk) {
                return;
            }

            try {
                await state.clerk.signOut();
                state.user = null;
                state.isAuthenticated = false;

                // Generate fresh anonymous session ID (don't reuse old session)
                localStorage.removeItem('session_id'); // Remove old session
                const newSessionId = crypto.randomUUID(); // Generate fresh UUID
                state.sessionId = newSessionId;
                localStorage.setItem('session_id', newSessionId); // Persist new session
                console.log('Generated new anonymous session:', newSessionId);

                updateAuthUI();
                addMessage('system', 'Signed out successfully');
            } catch (error) {
                console.error('Error signing out:', error);
                showErrorBanner('Failed to sign out. Please try again.');
            }
        }

        /**
         * Claim anonymous scans when user signs in
         */
        async function claimAnonymousScans() {
            const sessionId = localStorage.getItem('session_id');

            if (!sessionId) {
                console.log('No anonymous scans to claim');
                return;
            }

            if (!state.isAuthenticated) {
                console.log('Cannot claim scans - not authenticated');
                return;
            }

            try {
                console.log('Claiming anonymous scans for session:', sessionId);

                const headers = await buildHeaders();

                const response = await fetch(`${CONFIG.API_BASE_URL}/scans/claim`, {
                    method: 'POST',
                    headers: headers,
                    credentials: CONFIG.USE_COOKIES ? 'include' : 'same-origin',
                    body: JSON.stringify({ session_id: sessionId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('Successfully claimed scans:', data);

                if (data.claimed_count > 0) {
                    addMessage('system', `✓ Claimed ${data.claimed_count} previous scan(s)`);
                    // Clear the old session ID
                    localStorage.removeItem('session_id');
                }

            } catch (error) {
                console.error('Error claiming scans:', error);
                // Don't show error to user - this is a background operation
            }
        }

        // ============================================================
        // ERROR BANNER FUNCTIONS
        // ============================================================

        /**
         * Show error banner with optional retry action
         */
        function showErrorBanner(message, retryAction = null) {
            const banner = document.getElementById('errorBanner');
            const text = document.getElementById('errorBannerText');
            const retryBtn = document.getElementById('retryBtn');

            text.textContent = message;
            banner.classList.add('visible');

            if (retryAction) {
                state.lastFailedAction = retryAction;
                retryBtn.style.display = 'block';
            } else {
                state.lastFailedAction = null;
                retryBtn.style.display = 'none';
            }
        }

        /**
         * Dismiss error banner
         */
        function dismissErrorBanner() {
            const banner = document.getElementById('errorBanner');
            banner.classList.remove('visible');
            state.lastFailedAction = null;
        }

        /**
         * Retry last failed action
         */
        function retryLastAction() {
            if (state.lastFailedAction) {
                dismissErrorBanner();
                state.lastFailedAction();
            }
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================

        /**
         * Initialize application on page load
         */
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');

            // Initialize session ID for anonymous users
            state.sessionId = getOrCreateSessionId();

            // Show Clerk configuration UI if needed
            updateClerkConfigUI();

            // Initialize Clerk authentication
            await initializeClerk();

            // Initialize Socket.io connection
            initializeSocket();
        });
    </script>
</body>
</html>
