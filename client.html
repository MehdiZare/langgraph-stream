<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Scanner - Socket.io</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.processing {
            background: #cfe2ff;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            font-size: 13px;
            font-style: italic;
            max-width: 100%;
            text-align: center;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            max-width: 100%;
        }

        .message.structured {
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            max-width: 90%;
        }

        .structured-analysis {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .structured-analysis h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .analysis-field {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .analysis-field strong {
            color: #667eea;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .analysis-field ul {
            margin: 10px 0 0 20px;
            padding: 0;
            list-style-type: disc;
        }

        .analysis-field li {
            margin: 5px 0;
            color: #333;
        }

        .message.seo-recommendation {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            max-width: 95%;
        }

        .seo-analysis h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ranking-badge {
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin: 0 3px;
        }

        .ranking-badge.google {
            background: #4285f4;
        }

        .ranking-badge.bing {
            background: #008373;
        }

        .ranking-badge.not-ranked {
            background: #ffc107;
            color: #333;
        }

        .seo-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .seo-section:last-child {
            margin-bottom: 0;
        }

        .seo-section strong {
            color: #667eea;
            display: block;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .seo-content {
            color: #333;
            line-height: 1.6;
        }

        .seo-content p {
            margin: 10px 0;
        }

        .seo-content ul,
        .seo-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }

        .seo-content li {
            margin: 5px 0;
        }

        /* Progress Bar Styles */
        .progress-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            display: none;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .mode-toggle {
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            gap: 20px;
        }

        .mode-toggle label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
        }

        .mode-toggle input[type="radio"] {
            cursor: pointer;
        }

        .mode-toggle label:has(input:checked) {
            color: #667eea;
            font-weight: 600;
        }

        /* Screenshot Display Styles */
        .message.screenshot {
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 15px;
            max-width: 95%;
        }

        .screenshot-container {
            position: relative;
            margin-bottom: 10px;
        }

        .screenshot-container img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
        }

        .screenshot-loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            height: 300px;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        .screenshot-label {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .full-quality-link {
            font-size: 12px;
            color: #667eea;
            text-decoration: none;
            margin-top: 8px;
            display: inline-block;
        }

        .full-quality-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Website Scanner (Socket.io)</h1>
        <p class="subtitle">AI-powered website analysis with real-time updates</p>

        <div id="status" class="status connecting">
            Connecting to server...
        </div>

        <div class="mode-toggle">
            <label>
                <input type="radio" name="scanMethod" value="api" checked>
                REST API + Socket.io (Recommended)
            </label>
            <label>
                <input type="radio" name="scanMethod" value="socket">
                Socket.io Only
            </label>
        </div>

        <div class="quick-actions">
            <button class="quick-btn" onclick="sendQuickURL('https://github.com')">GitHub</button>
            <button class="quick-btn" onclick="sendQuickURL('https://news.ycombinator.com')">Hacker News</button>
            <button class="quick-btn" onclick="sendQuickURL('https://www.anthropic.com')">Anthropic</button>
            <button class="quick-btn" onclick="clearChat()">Clear Chat</button>
        </div>

        <div id="progressContainer" class="progress-container">
            <div class="progress-bar-wrapper">
                <div id="progressBar" class="progress-bar" role="progressbar"
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    0%
                </div>
            </div>
            <div id="progressText" class="progress-text">Initializing...</div>
        </div>

        <div id="chatContainer" class="chat-container"></div>

        <div class="input-container">
            <input
                type="text"
                id="urlInput"
                placeholder="Enter a website URL (e.g., https://example.com)..."
                onkeypress="handleKeyPress(event)"
            />
            <button id="sendBtn" onclick="sendMessage()" disabled>Analyze</button>
        </div>
    </div>

    <script>
        // State management
        const state = {
            socket: null,
            sessionId: null,
            currentScanId: null,
            isAuthenticated: false,
            isConnected: false
        };

        // Initialize Socket.io connection
        function initializeSocket() {
            console.log('Initializing Socket.io connection...');

            state.socket = io({
                reconnection: true,
                reconnectionDelay: 3000,
                reconnectionAttempts: Infinity
            });

            // Connection events
            state.socket.on('connect', handleConnect);
            state.socket.on('disconnect', handleDisconnect);
            state.socket.on('connect_error', handleConnectError);

            // Auth events
            state.socket.on('auth_response', handleAuthResponse);

            // Scan events
            state.socket.on('analyze_response', handleAnalyzeResponse);
            state.socket.on('scan:progress', handleScanProgress);
            state.socket.on('scan:screenshot_loading', handleScanScreenshotLoading);
            state.socket.on('scan:screenshot', handleScanScreenshot);
            state.socket.on('scan:completed', handleScanCompleted);
            state.socket.on('scan:failed', handleScanFailed);
            state.socket.on('scan:issue', handleScanIssue);

            // Room events
            state.socket.on('joined', handleRoomJoined);
            state.socket.on('left', handleRoomLeft);

            // Error events
            state.socket.on('error', handleError);
        }

        // Connection handlers
        function handleConnect() {
            console.log('Socket.io connected');
            state.isConnected = true;
            updateStatus('connected', '‚úì Connected to server');

            // Get session_id from localStorage
            const sessionId = localStorage.getItem('session_id');

            // Send auth (anonymous - no login required)
            state.socket.emit('auth', {
                token: null,
                session_id: sessionId
            });
        }

        function handleDisconnect() {
            console.log('Socket.io disconnected');
            state.isConnected = false;
            updateStatus('disconnected', '‚úó Disconnected from server');
            document.getElementById('sendBtn').disabled = true;
        }

        function handleConnectError(error) {
            console.error('Socket.io connection error:', error);
            updateStatus('disconnected', '‚úó Connection error');
            addMessage('error', `Connection error: ${error.message || 'Unknown error'}`);
        }

        // Auth handlers
        function handleAuthResponse(data) {
            console.log('Auth response:', data);

            if (!data.authenticated && data.session_id) {
                state.sessionId = data.session_id;
                localStorage.setItem('session_id', data.session_id);
                console.log('Anonymous session created:', data.session_id);
            }

            // Enable UI
            document.getElementById('sendBtn').disabled = false;
        }

        // Scan event handlers
        function handleAnalyzeResponse(data) {
            console.log('Analyze response:', data);
            state.currentScanId = data.scan_id;
            addMessage('system', `‚úì Scan created: ${data.scan_id}`);
            showProgressBar();
        }

        function handleScanProgress(data) {
            console.log('Scan progress:', data);
            updateProgressBar(data.percent, data.message);
        }

        function handleScanScreenshotLoading(data) {
            console.log('Screenshot loading for scan:', data.scan_id);
            displayScreenshotLoading(data.scan_id);
        }

        function handleScanScreenshot(data) {
            console.log('Screenshot received for scan:', data.scan_id);
            displayScreenshot(data.screenshot, data.scan_id);
        }

        function handleScanCompleted(data) {
            console.log('Scan completed:', data);
            hideProgressBar();

            // Display results
            if (data.results) {
                if (data.results.analysis) {
                    displayStructuredAnalysis(data.results.analysis);
                }

                if (data.results.seo) {
                    displaySEORecommendation(data.results.seo);
                }
            }

            addMessage('system', '‚úÖ Scan completed successfully!');
            updateStatus('connected', '‚úì Connected to server');
        }

        function handleScanFailed(data) {
            console.error('Scan failed:', data);
            hideProgressBar();
            addMessage('error', `‚úó Scan failed: ${data.error}`);
            updateStatus('connected', '‚úì Connected to server');
        }

        function handleScanIssue(data) {
            console.log('Scan issue:', data);
            addMessage('system', `‚ö† Issue: ${JSON.stringify(data.issue)}`);
        }

        // Room handlers
        function handleRoomJoined(data) {
            console.log('Joined room:', data);
        }

        function handleRoomLeft(data) {
            console.log('Left room:', data);
        }

        // Error handler
        function handleError(data) {
            console.error('Socket.io error:', data);
            addMessage('error', data.message || 'An error occurred');
        }

        // REST API scan creation
        async function createScanViaAPI(url) {
            try {
                updateStatus('processing', '‚è≥ Creating scan...');

                const headers = {
                    'Content-Type': 'application/json'
                };

                // Include session_id if available (for anonymous users)
                if (state.sessionId) {
                    headers['X-Session-ID'] = state.sessionId;
                    console.log('Sending X-Session-ID header:', state.sessionId);
                } else {
                    console.warn('No session_id available - scan may not be accessible later');
                }

                const response = await fetch('/api/scans', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Scan created via API:', data);

                // Save current scan ID
                state.currentScanId = data.scan_id;

                addMessage('system', `‚úì Scan created: ${data.scan_id}`);

                // Join scan room via Socket.io
                state.socket.emit('join', {
                    scan_id: data.scan_id
                });

                // Show progress bar
                showProgressBar();
                updateStatus('processing', '‚è≥ Scanning...');

                return data;
            } catch (error) {
                console.error('Error creating scan:', error);
                addMessage('error', `Failed to create scan: ${error.message}`);
                updateStatus('connected', '‚úì Connected to server');
                throw error;
            }
        }

        // Socket.io scan creation
        function createScanViaSocket(url, mode = 'structured') {
            if (!state.socket || !state.socket.connected) {
                addMessage('error', 'Not connected to server');
                return;
            }

            updateStatus('processing', '‚è≥ Starting scan...');

            state.socket.emit('analyze', {
                url: url,
                mode: mode
            });

            showProgressBar();
        }

        // UI Functions
        function updateStatus(state, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${state}`;
            statusEl.textContent = message;
        }

        function showProgressBar() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.classList.add('visible');
            updateProgressBar(0, 'Starting scan...');
        }

        function updateProgressBar(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            progressBar.style.width = `${percent}%`;
            progressBar.setAttribute('aria-valuenow', percent);
            progressBar.textContent = `${percent}%`;
            progressText.textContent = `${percent}% - ${message}`;
        }

        function hideProgressBar() {
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.classList.remove('visible');
        }

        function addMessage(type, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = content;
            chatContainer.appendChild(messageEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageEl;
        }

        function displayScreenshotLoading(scanId) {
            const chatContainer = document.getElementById('chatContainer');

            // Create loading placeholder
            const screenshotEl = document.createElement('div');
            screenshotEl.className = 'message screenshot';
            screenshotEl.id = `screenshot-${scanId}`;

            screenshotEl.innerHTML = `
                <div class="screenshot-label">
                    üì∏ Page Screenshot (Preview)
                </div>
                <div class="screenshot-container">
                    <div class="screenshot-loading"></div>
                </div>
            `;

            chatContainer.appendChild(screenshotEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayScreenshot(screenshotDataUrl, scanId) {
            // Validate data URI format
            if (!screenshotDataUrl || !screenshotDataUrl.startsWith('data:image/')) {
                console.error('Invalid screenshot data URL format');
                return;
            }

            // Validate scanId format (UUID)
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!scanId || !uuidRegex.test(scanId)) {
                console.error('Invalid scan ID format');
                return;
            }

            const chatContainer = document.getElementById('chatContainer');

            // Check if loading placeholder exists
            const existingScreenshot = document.getElementById(`screenshot-${scanId}`);

            if (existingScreenshot) {
                // Update existing placeholder with actual screenshot
                existingScreenshot.innerHTML = `
                    <div class="screenshot-label">
                        üì∏ Page Screenshot (Preview)
                    </div>
                    <div class="screenshot-container">
                        <img src="${screenshotDataUrl}" alt="Website Screenshot" loading="lazy">
                    </div>
                    <a href="javascript:void(0)" onclick="fetchAndOpenScreenshot('${scanId}')" class="full-quality-link">
                        üîç View Full Quality Screenshot
                    </a>
                `;
            } else {
                // Create new screenshot element if loading wasn't shown
                const screenshotEl = document.createElement('div');
                screenshotEl.className = 'message screenshot';
                screenshotEl.id = `screenshot-${scanId}`;

                screenshotEl.innerHTML = `
                    <div class="screenshot-label">
                        üì∏ Page Screenshot (Preview)
                    </div>
                    <div class="screenshot-container">
                        <img src="${screenshotDataUrl}" alt="Website Screenshot" loading="lazy">
                    </div>
                    <a href="javascript:void(0)" onclick="fetchAndOpenScreenshot('${scanId}')" class="full-quality-link">
                        üîç View Full Quality Screenshot
                    </a>
                `;

                chatContainer.appendChild(screenshotEl);
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayStructuredAnalysis(analysis) {
            const chatContainer = document.getElementById('chatContainer');

            const analysisEl = document.createElement('div');
            analysisEl.className = 'message assistant structured';

            // Sanitize all user-controlled fields to prevent XSS
            const sanitizedType = DOMPurify.sanitize(analysis.website_type || 'N/A');
            const sanitizedGoal = DOMPurify.sanitize(analysis.primary_goal || 'N/A');
            const sanitizedDescription = DOMPurify.sanitize(analysis.description || 'N/A');
            const sanitizedFeatures = (analysis.key_features || [])
                .map(f => `<li>${DOMPurify.sanitize(f)}</li>`)
                .join('');
            const sanitizedKeywords = DOMPurify.sanitize((analysis.keywords || []).join(', ') || 'N/A');

            analysisEl.innerHTML = `
                <div class="structured-analysis">
                    <h3>üìä Website Analysis</h3>
                    <div class="analysis-field">
                        <strong>Type:</strong> ${sanitizedType}
                    </div>
                    <div class="analysis-field">
                        <strong>Primary Goal:</strong> ${sanitizedGoal}
                    </div>
                    <div class="analysis-field">
                        <strong>Description:</strong> ${sanitizedDescription}
                    </div>
                    <div class="analysis-field">
                        <strong>Key Features:</strong>
                        <ul>
                            ${sanitizedFeatures}
                        </ul>
                    </div>
                    <div class="analysis-field">
                        <strong>Keywords:</strong> ${sanitizedKeywords}
                    </div>
                </div>
            `;

            chatContainer.appendChild(analysisEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displaySEORecommendation(seo) {
            const chatContainer = document.getElementById('chatContainer');

            const seoEl = document.createElement('div');
            seoEl.className = 'message seo-recommendation';

            // Ranking badges
            const googleBadge = seo.google_ranking
                ? `<span class="ranking-badge google">Google #${seo.google_ranking}</span>`
                : `<span class="ranking-badge not-ranked">Not in Top 10</span>`;

            const bingBadge = seo.bing_ranking
                ? `<span class="ranking-badge bing">Bing #${seo.bing_ranking}</span>`
                : `<span class="ranking-badge not-ranked">Not in Top 10</span>`;

            // Sanitize markdown output to prevent XSS attacks
            const sanitizedFindings = DOMPurify.sanitize(marked.parse(seo.findings || 'No findings available'));
            const sanitizedRecommendations = DOMPurify.sanitize(marked.parse(seo.recommendations || 'No recommendations available'));
            const sanitizedAttention = DOMPurify.sanitize(marked.parse(seo.require_attention || 'No critical issues'));

            seoEl.innerHTML = `
                <div class="seo-analysis">
                    <h3>üéØ SEO Analysis ${googleBadge} ${bingBadge}</h3>
                    <div class="seo-section">
                        <strong>Findings</strong>
                        <div class="seo-content">${sanitizedFindings}</div>
                    </div>
                    <div class="seo-section">
                        <strong>Recommendations</strong>
                        <div class="seo-content">${sanitizedRecommendations}</div>
                    </div>
                    <div class="seo-section">
                        <strong>Require Attention</strong>
                        <div class="seo-content">${sanitizedAttention}</div>
                    </div>
                </div>
            `;

            chatContainer.appendChild(seoEl);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function clearChat() {
            document.getElementById('chatContainer').innerHTML = '';
        }

        async function fetchAndOpenScreenshot(scanId) {
            try {
                const headers = { 'Content-Type': 'application/json' };

                // Add session_id for anonymous users
                if (state.sessionId) {
                    headers['X-Session-ID'] = state.sessionId;
                }

                const response = await fetch(`/api/scans/${scanId}/screenshot-url`, {
                    headers: headers
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

                const data = await response.json();

                // Open presigned URL in new tab
                if (data.screenshot_url) {
                    window.open(data.screenshot_url, '_blank');
                } else {
                    throw new Error('Screenshot URL not found in response');
                }

            } catch (error) {
                console.error('Error fetching screenshot:', error);
                addMessage('error', `Failed to load full quality screenshot: ${error.message}`);
            }
        }

        // User action handlers
        async function sendMessage() {
            const input = document.getElementById('urlInput');
            const url = input.value.trim();

            if (!url) return;

            if (!state.socket || !state.socket.connected) {
                addMessage('error', '‚úó Not connected to server');
                return;
            }

            // Display user input
            addMessage('user', url);

            // Get selected scan method
            const scanMethod = document.querySelector('input[name="scanMethod"]:checked').value;

            try {
                if (scanMethod === 'api') {
                    // Create scan via REST API (recommended)
                    await createScanViaAPI(url);
                } else {
                    // Create scan via Socket.io
                    createScanViaSocket(url, 'structured');
                }
            } catch (error) {
                // Error already handled in respective functions
            }

            // Clear input
            input.value = '';
        }

        async function sendQuickURL(url) {
            if (!state.socket || !state.socket.connected) {
                addMessage('error', '‚úó Not connected to server');
                return;
            }

            addMessage('user', url);

            const scanMethod = document.querySelector('input[name="scanMethod"]:checked').value;

            try {
                if (scanMethod === 'api') {
                    await createScanViaAPI(url);
                } else {
                    createScanViaSocket(url, 'structured');
                }
            } catch (error) {
                // Error already handled
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Page loaded, initializing Socket.io...');
            initializeSocket();
        });
    </script>
</body>
</html>
